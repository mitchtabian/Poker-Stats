{% extends "base.html" %}

{% load tournament_extras %}

{% block head_title %}Tournaments{% endblock %}

{% block content %}

<div class="container" id="parent">
  <div class="row">
    <div class="offset-lg-3 col-lg-6">

      <!-- title -->
      <h2>
        <div class="d-flex">
          <span class="tournament-title">{{tournament.title}}</span>
        </div>
      </h2>

      <!-- Description -->
      <div class="mt-4 backfill-description">
        <p>Backfilling data for a tournament that's already completed.</p>
      </div>

      <!-- Placements -->
      <h2 class="backfill-display-group-header">Placements</h2>
      <hr>
      <div class="backfill-display-group">
        {% for position in num_payout_positions_iterator %}
        <div class="backfill-placement-container {% if forloop.counter0 > 0 %}mt-3{% endif %}">
        <p class="placement-header">{{forloop.counter0|format_placement}}</p>
        <select class="form-select" aria-label="Who came in {{forloop.counter0|format_placement}}" id="id_player_placement_selector_{{forloop.counter0}}"  onchange="onPlacementChanged('{{forloop.counter0}}')">
          <option value="-1">---------</option>
          {% for player in players %}
            {% if placements_dict|keyvalue:position == player.id|stringformat:"i" %}
              <option value="{{player.id}}" selected>{{player.user.username}}</option>
            {% else %}
              <option value="{{player.id}}">{{player.user.username}}</option>
            {% endif %}
          {% endfor %}
        </select>
        </div>
        {% endfor %}
      </div>

      <!-- Eliminations and Split Eliminations -->
      {% include 'tournament/snippets/backfill_eliminations_snippet.html' %}

      <!-- Rebuys if not a bounty tournament -->
      <!-- Pull this our into a snippet -->
      {% if tournament.tournament_structure.bounty_amount == None and tournament.tournament_structure.allow_rebuys == True %}
      <h2 class="backfill-display-group-header">Rebuys</h2>
      <hr>
      {% for player in players %}
        <div class="backfill-display-group mb-4">
          <p class="rebuy-player-username">{{player.user.username}}</p>
          <div class="input-group rebuys-input">
            <span class="input-group-text">Rebuys</span>
            <input class="form-control" aria-label="Rebuys" id="{{player.id}}_rebuy_input" type="number" onchange="updateRebuys('{{player.id}}')" value="{{rebuys_dict|keyvalue:player.id}}">
          </div>
          <div class="rebuy-input-error" id="{{player.id}}_rebuy_input_error"></div>
        </div>
      {% endfor %}

      <!-- Submit button for saving -->
      <h2 class="backfill-display-group-header">Save</h2>
      <hr>
      <form method="POST">
        {% csrf_token %}
        <!-- Hidden htmx input -->
        <input class="d-none" id="id_hidden_htmx_data" hx-get="{% url 'tournament:tournament_backfill' pk=tournament.id %}" hx-trigger="click" hx-target="#body_container" name="data_json" value="{{json_dict}}">

        <!-- Hidden actual submit button -->
        <!-- todo remove-->
        <button class="d-none" id="id_real_submit_btn" type="submit">...</button>

      </form>

      <div class="d-flex flex-row justify-content-start">
        <button class="btn btn-primary backfill-submit-btn" id="id_fake_submit_btn" onclick="trySubmitForm()">Submit backfill data</button>
      </div>

      <!-- todo remove -->
      <!-- Fake submit button for performing validation for a tournament with rebuys enabled and bounties disabled. -->
     <!--  <div class="d-flex flex-row justify-content-start">
        <button class="btn btn-primary backfill-submit-btn" id="id_fake_submit_btn" onclick="trySubmitForm()">Submit backfill data</button>
      </div> -->

      {% else %} <!-- This is a bounty tournament -->
      <!-- todo pull this out into a snippet -->
      <!-- Submit button for saving -->
      <h2 class="backfill-display-group-header">Save</h2>
      <hr>
      <form method="POST">
        {% csrf_token %}
        <!-- Hidden htmx input -->
        <input class="d-none" id="id_hidden_htmx_data" hx-get="{% url 'tournament:tournament_backfill' pk=tournament.id %}" hx-trigger="click" hx-target="#body_container" name="data_json" value="{{json_dict}}">

        <div class="d-flex flex-row justify-content-start">
          <button class="btn btn-primary backfill-submit-btn" type="submit">Submit backfill data</button>
        </div>
      </form>
      {% endif %}

    </div>
  </div>
</div>

<script src="https://unpkg.com/htmx.org@1.8.5"></script>

<script type="text/javascript">
  // Initialize tooltip plugin
  $(function () {
    $('[data-toggle="tooltip"]').tooltip()
  })

  document.body.addEventListener('htmx:configRequest', (event) => {
    event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
  })

</script>
<script type="text/javascript">

  /**
   * Data payload sent to view containing eliminations and placements data.
   * Sent using htmx.
   * {
   *   "placements": {
   *     "0": "<player_id>", <-- first
   *     "1": "<player_id>", <-- second
   *     etc...
   *   },
   *   "eliminations": [
   *    {
   *     "eliminator_id": "1",
   *     "eliminatee_id": "25"
   *    },
   *    {
   *     "eliminator_id": "2",
   *     "eliminatee_id": "1"
   *    },
   *    {
   *     "eliminator_id": "1",
   *     "eliminatee_id": "2"
   *    },
   *   ... etc
   *   ],
   *   "split_eliminations": [
   *      {
   *       "eliminator_ids": [
   *         "<player_id5>",
   *         "<player_id4>",
   *       ],
   *       "eliminatee_id": "25"
   *      },
   *      {
   *       "eliminator_ids": [
   *         "<player_id7>",
   *         "<player_id4>",
   *         "<player_id55>",
   *       ],
   *       "eliminatee_id": "25"
   *      },
   *       ... etc
   *    ],
   *
   *    "selected_eliminatee_id": "1", <-- The currently selected eliminatee for split.
   *    "selected_eliminator_ids": {
   *      "0": "<player_id5",
   *      "1": "<player_id7",
   *      ...
   *    },
   *
   *    "rebuys": {
   *      "<player_id2>": "2",
   *      "<player_id6>": "1",
   *      "<player_id1>": "2",
   *    }
   * }
   * */

  function validateRebuyInputs() {
    {% for player in players %}
      var player_id = "{{player.id}}"
      input_element = document.getElementById(player_id + "_rebuy_input")
      element_value = input_element.value
      error_element = document.getElementById(player_id + "_rebuy_input_error")
      error_element.innerHTML = ""
      var are_all_numbers = true
      if (element_value.length > 0) {
        if (isNaN(element_value)) {
          // That is not a number.
          error_element.innerHTML = "That is not a number."
          are_all_numbers = false
        } else if (Number(element_value) % 1 != 0) {
          // Rebuy values must be whole numbers.
          error_element.innerHTML = "Rebuy values must be whole numbers."
          are_all_numbers = false
        }
      }
      if(!are_all_numbers) {
        document.getElementById("id_fake_submit_btn").classList.add("disabled")
      }
    {% endfor %}
    return are_all_numbers
  }

  function updateRebuys(player_id) {
    setTimeout(function() {
      document.getElementById("id_fake_submit_btn").classList.remove("disabled")
      console.log("updateRebuys")
      input_element = document.getElementById(player_id + "_rebuy_input")
      element_value = input_element.value
      error_element = document.getElementById(player_id + "_rebuy_input_error")
      error_element.innerHTML = ""
      var are_all_numbers = true
      if (element_value.length > 0) {
        if (isNaN(element_value)) {
          // That is not a number.
          error_element.innerHTML = "That is not a number."
          are_all_numbers = false
        } else if (Number(element_value) % 1 != 0) {
          // Rebuy values must be whole numbers.
          error_element.innerHTML = "Rebuy values must be whole numbers."
          are_all_numbers = false
        } else {
          var htmx_button = document.getElementById("id_hidden_htmx_data")
          var jsonData = getJsonFromHtmxField()
          if (jsonData == null) {
            jsonData = buildNewDataJson()
          }
          jsonData['rebuys'][player_id] = element_value
          htmx_button.value = JSON.stringify(jsonData)
          htmx_button.click()
          console.log("jsonData: " + JSON.stringify(jsonData))
        }
      }
      if(!are_all_numbers) {
        console.log("Disabled or something?")
        document.getElementById("id_fake_submit_btn").classList.add("disabled")
      }
    }, 50);
  }

  function trySubmitForm() {
    console.log("trySubmitForm")
    // Delay the submission of the form in case the rebuy fields have errors. The button gets disabled.
    setTimeout(function() {
      console.log("validateRebuyInputs: " + validateRebuyInputs())
      if (validateRebuyInputs()) {
        document.getElementById("id_real_submit_btn").click()
      }
    }, 200);
  }


  function submitSplitElimination() {
    var htmx_button = document.getElementById("id_hidden_htmx_data")
    var jsonData = getJsonFromHtmxField()
    if (jsonData == null) {
      jsonData = buildNewDataJson()
    }
    selected_eliminatee_id = jsonData.selected_eliminatee_id
    selected_eliminator_ids = JSON.parse("[]")
    Object.entries(jsonData.selected_eliminator_ids).forEach((entry) => {
      const [key, value] = entry;
      selected_eliminator_ids.push(value)
    });
    new_split_elimination = JSON.parse("{}")
    new_split_elimination['eliminator_ids'] = selected_eliminator_ids
    new_split_elimination['eliminatee_id'] = selected_eliminatee_id
    jsonData['split_eliminations'].push(new_split_elimination)
    // Clear the selected eliminators
    jsonData['selected_eliminator_ids'] = JSON.parse("{}")
    jsonData['selected_eliminatee_id'] = JSON.parse("-1")
    // Update the hidden field
    htmx_button.value = JSON.stringify(jsonData)
    htmx_button.click()
  }

  function selectEliminateeForSplit() {
    var selector_id = "id_split_eliminatee"
    var options = document.getElementById(selector_id).querySelectorAll("option");
    for (let index = 0; index < options.length; index++) {
      if (options[index].selected) {
        var htmx_button = document.getElementById("id_hidden_htmx_data")
        var player_id = options[index].value
        var jsonData = getJsonFromHtmxField()
        if (jsonData == null) {
          jsonData = buildNewDataJson()
          jsonData['selected_eliminatee_id'] = player_id
        } else {
          jsonData['selected_eliminatee_id'] = player_id
        }
        // Clear the selected eliminators
        jsonData['selected_eliminator_ids'] = JSON.parse("{}")
        // Update the hiddnen field
        htmx_button.value = JSON.stringify(jsonData)
        htmx_button.click()
        break
      }
    }
  }

  function selectEliminatorForSplit(eliminator_number, player_id) {
    var selector_id = "id_split_eliminator_" + player_id
    var options = document.getElementById(selector_id).querySelectorAll("option");
    for (let index = 0; index < options.length; index++) {
       if (options[index].selected) {
        var htmx_button = document.getElementById("id_hidden_htmx_data")
        var eliminator_player_id = options[index].value
        var jsonData = getJsonFromHtmxField()
        if (jsonData == null) {
          jsonData = buildNewDataJson()
          new_split_elimination = JSON.parse()
          jsonData['selected_eliminator_ids'][eliminator_number] = eliminator_player_id
        } else {
          jsonData['selected_eliminator_ids'][eliminator_number] = eliminator_player_id
        }
        htmx_button.value = JSON.stringify(jsonData)
        htmx_button.click()
       }
    }
  }

  function onPlacementChanged(placement) {
    var selector_id = "id_player_placement_selector_" + placement
    var options = document.getElementById(selector_id).querySelectorAll("option");
    for (let index = 0; index < options.length; index++) {
      if (options[index].selected) {
        var htmx_button = document.getElementById("id_hidden_htmx_data")
        var player_id = options[index].value
        var jsonData = getJsonFromHtmxField()
        if (jsonData == null) {
          jsonData = buildNewDataJson()
          jsonData['placements'][placement] = player_id
        } else {
          jsonData['placements'][placement] = player_id
        }
        console.log("jsonData: " + JSON.stringify(jsonData))
        htmx_button.value = JSON.stringify(jsonData)
        htmx_button.click()
        break
      }
    }
  }

  function selectElimination(player_id) {
    var selector_id = "id_" + player_id + "_new_elim"
    var options = document.getElementById(selector_id).querySelectorAll("option");
    for (let index = 0; index < options.length; index++) {
      if (options[index].selected) {
        var htmx_button = document.getElementById("id_hidden_htmx_data")
        var jsonData = getJsonFromHtmxField()
        if (jsonData == null) {
          jsonData = buildNewDataJson()
          var newJson = JSON.parse('{ "eliminator_id": "' + player_id + '", "eliminatee_id": "' + options[index].value + '" }')
          jsonData['eliminations'].push(newJson)
        } else {
          var newJson = JSON.parse('{ "eliminator_id": "' + player_id + '", "eliminatee_id": "' + options[index].value + '" }')
          jsonData['eliminations'].push(newJson)
        }
        htmx_button.value = JSON.stringify(jsonData)
        htmx_button.click()
        break
      }
    }
  }

  function resetEliminations(player_id) {
    let jsonData = getJsonFromHtmxField()
    // Rebuild the json object. Ignoring the entries from player_id.
    // copy the json data and clear the eliminations
    let jsonDataCopy = JSON.parse(JSON.stringify(jsonData));
    jsonDataCopy['eliminations'] = JSON.parse("[]")
    for(var key in jsonData['eliminations']) {
      var eliminator_id_data = JSON.stringify(jsonData['eliminations'][key]['eliminator_id']).replace(/"/g,'')
      var eliminatee_id_data = JSON.stringify(jsonData['eliminations'][key]['eliminatee_id']).replace(/"/g,'')
      if (player_id == eliminator_id_data) {
        // Do nothing. This entry needs to be removed.
      } else {
        var newJson = JSON.parse('{ "eliminator_id": "' + eliminator_id_data + '", "eliminatee_id": "' + eliminatee_id_data + '" }')
        jsonDataCopy['eliminations'].push(newJson)
      }
    }
    var htmx_button = document.getElementById("id_hidden_htmx_data")
    htmx_button.value = JSON.stringify(jsonDataCopy)
    htmx_button.click()
  }

  function getJsonFromHtmxField() {
    var htmx_button = document.getElementById("id_hidden_htmx_data")
    var valueJson = null
    try{
      valueJson = JSON.parse(htmx_button.value)
    }catch (e){
      valueJson = null
    }
    return valueJson
  }

  function buildNewDataJson() {
    return JSON.parse('{ "placements": {}, "eliminations": [], "split_eliminations" : [], "selected_eliminatee_id": "-1", "selected_eliminator_ids": {}, "rebuys": {} }')
  }

</script>

<style type="text/css">
  hr {
    margin-top: 8px;
    margin-bottom: 8px;
  }

  .player-eliminations-header {
    align-items: center;
  }

  .eliminations-reset-btn {
    color: white;
    background-color: #d9534f;
    padding-top:0px;
    padding-bottom:0px;
    padding-right:6px;
    padding-left:6px;
  }

  .eliminations-reset-btn:hover {
    color: white;
    background-color: #e89996;
    padding-top:0px;
    padding-bottom:0px;
    padding-right:6px;
    padding-left:6px;
  }

  @media only screen and (max-width: 500px) {
    .backfill-display-group {
      font-size: 16px;
      padding-left: 16px;
      padding-right: 16px;
      padding-bottom: 16px;
      padding-top: 16px;
      background-color: #f2f2f2;
      border-radius: 8px;
    }

    .backfill-display-group-header {
      font-size: 20px;
      margin-top: 20px;
    }

    .backfill-submit-btn {
      font-size: 12px;
      margin-top: 12px;
    }
    .elimination-username {
      font-size: 12px;
      vertical-align: middle;
      max-width: 180px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .remove-elimination-btn {
      color: #d9534f;
      vertical-align: middle;
    }
    .elim-selector-group {
      margin-top: 8px;
    }

    .player-eliminations-list {
      margin-top: 8px;
    }

    .player-eliminations-header-username {
      margin-right: 8px;
      font-weight: 500;
      font-size: 16px;
      max-width: 250px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .placement-header {
      font-weight: 500;
      font-size: 16px;
    }

    .backfill-description {
      font-size: 14px;
    }

    .backfill-placement-container {
      padding: 8px;
      background-color: white;
      border-radius: 8px;
    }

    .split-elimination-input-form {
      display: flex;
      flex-direction: column;
    }
    .eliminator-selector-for-split-header {
      font-size: 14px;
      margin-bottom: 8px;
      margin-top: 16px;
    }
    .eliminatee-selector-for-split-header {
      font-size: 14px;
      margin-bottom: 8px;
    }
    .split-eliminations-list-container {
      margin-top: 16px;
      margin-bottom: 16px;
    }
    .split-eliminations-info-icon {
      margin-left: 8px;
    }
    .split-elimination-error {
      margin-top: 16px;
      margin-bottom: 16px;
      border: 2px solid red;
      border-radius: 4px;
      padding: 16px;
      font-size: 16px;
    }

    .rebuy-container {
      margin-bottom: 12px;
    }

    .rebuy-player-username {
      font-size: 14px;
      margin-bottom: 8px;
      font-weight: 450;
      max-width: 200px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .rebuy-input-error {
      padding: 8px;
      color: #d9534f;
    }
  }

  @media only screen and (min-width: 501px) {
    .backfill-display-group {
      padding-left: 16px;
      padding-right: 16px;
      padding-bottom: 16px;
      padding-top: 16px;
      font-size: 16px;
      background-color: #f2f2f2;
      border-radius: 8px;
    }

    .backfill-display-group-header {
      font-size: 23px;
      margin-top: 24px;
    }

    .backfill-submit-btn {
      font-size: 16px;
      margin-top: 16px;
    }
    .elimination-username {
      font-size: 16px;
      vertical-align: middle;
      max-width: 430px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .remove-elimination-btn {
      color: #d9534f;
      vertical-align: middle;
    }
    .elim-selector-group {
      margin-top: 16px;
    }

    .player-eliminations-list {
      margin-top: 16px;
    }

    .player-eliminations-header-username {
      margin-right: 8px;
      font-weight: 500;
      font-size: 18px;
      max-width: 450px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .placement-header {
      font-weight: 500;
      font-size: 18px;
    }

    .backfill-description {
      font-size: 16px;
    }

    .backfill-placement-container {
      padding: 8px;
      background-color: white;
      border-radius: 8px;
    }

    .split-elimination-input-form {
      display: flex;
      flex-direction: column;
    }
    .eliminator-selector-for-split-header {
      font-size: 16px;
      margin-bottom: 8px;
      margin-top: 16px;
    }
    .eliminatee-selector-for-split-header {
      font-size: 16px;
      margin-bottom: 8px;
    }
    .split-eliminations-list-container {
      margin-top: 16px;
      margin-bottom: 16px;
    }
    .split-eliminations-info-icon {
      margin-left: 8px;
    }
    .split-elimination-error {
      margin-top: 16px;
      margin-bottom: 16px;
      border: 2px solid red;
      border-radius: 4px;
      padding: 16px;
      font-size: 16px;
    }
    .rebuy-container {
      margin-bottom: 12px;
    }

    .rebuy-player-username {
      font-size: 16px;
      margin-bottom: 8px;
      font-weight: 450;
      max-width: 350px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .rebuy-input-error {
      padding: 8px;
      color: #d9534f;
    }
  }

</style>

{% endblock content %}












